<hi:common_header runat="server" />
<input type="hidden" id="hdIsShow" runat="server" value="0" />
<link rel="stylesheet" href="../style/scart.css" />
<script src="css/layui/jquery-1.9.1.min.js" type="text/javascript"></script>
<style type="text/css">
    #toggle-button
    {
        display: none;
    }
    .button-label
    {
        position: relative;
        display: inline-block;
        width: 80px;
        height: 30px;
        background-color: #ccc;
        box-shadow: #ccc 0px 0px 0px 2px;
        border-radius: 30px;
        overflow: hidden;
    }
    .circle
    {
        position: absolute;
        top: 0;
        left: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #fff;
    }
    .button-label .text
    {
        line-height: 30px;
        font-size: 18px;
        text-shadow: 0 0 2px #ddd;
    }
    
    .on
    {
        color: #fff;
        display: none;
        text-indent: 10px;
    }
    .off
    {
        color: #fff;
        display: inline-block;
        text-indent: 34px;
    }
    .button-label .circle
    {
        left: 0;
        transition: all 0.3s;
    }
    #toggle-button:checked + label.button-label .circle
    {
        left: 50px;
    }
    #toggle-button:checked + label.button-label .on
    {
        display: inline-block;
    }
    #toggle-button:checked + label.button-label .off
    {
        display: none;
    }
    #toggle-button:checked + label.button-label
    {
        background-color: #51ccee;
    }
</style>
<div class="shoppingStepBar clearfix">
    <div class="step active text-left">
        <em style="margin-left: -8px;">购物车</em><div class="glyphicon glyphicon-ok">
        </div>
        <i></i>
    </div>
    <div class="step text-center">
        <em>确认订单</em><div class="glyphicon glyphicon-ok">
        </div>
    </div>
    <div class="step text-right">
        <em style="margin-right: -14px;">下单成功</em><div class="glyphicon glyphicon-ok">
        </div>
        <i></i>
    </div>
</div>
<hr />
<asp:panel id="divEmpty" runat="server" visible="false" cssclass="shopnull">
    <div class="bgimg"></div>
    <p class="emptytexttitle">暂未选购商品</p>
    <a href="/Default.aspx">去逛逛</a>
</asp:panel>
<asp:panel id="products" runat="server" style="display: inline-block; width: 100%;">
        <hi:vshoptemplatedrepeater id="rptCartProducts" templatefile="/Tags/skin-Common_CartProducts.ascx" runat="server" />
</asp:panel>
<asp:panel id="pointproducts" runat="server" style="display: inline-block; width: 100%;">
        <hr />
        <h3>积分兑换商品</h3>
        <hr />
        <hi:vshoptemplatedrepeater id="rptCartPointProducts" templatefile="/Tags/skin-Common_CartPointProducts.ascx" runat="server" />
</asp:panel>
<asp:panel id="pannelGo" runat="server" style="display: inline-block; width: 100%;">
    <div class="pbox" style="display: inline-block;">
        <ul class="pbox-bottom-left">
            <li>购物车合计（不含运费）：<span id="totalPrice"><asp:literal runat="server" id="litTotal" /></span></li>
        </ul>
    </div>
    <div class="pbox">
        <!--<a runat="server" id="aLink" style="color: #fff; margin-top: 5px; float: left;" class="btn btn-danger btn-block">
            去结算
        </a>-->
        <input id="btnSettlement" type="button" style="color: #fff; margin-top: 5px; float: left;" class="btn btn-danger btn-block" value="去结算" />
        
    </div>

    <!--积分兑换弹出框-->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title" id="myModalLabel">积分兑换</h4>
            </div>
            <div class="modal-body">
          <form class="form-horizontal" role="form">
  <div class="form-group">
    <label for="firstname" class="col-sm-2 control-label">积分兑换上限：</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="MaxIntegral" disabled/>
    </div>
  </div>
    <div class="form-group">
    <label for="firstname" class="col-sm-2 control-label">现有积分：</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="ExistingIntegral" disabled/>
    </div>
  </div>
  <div class="form-group">
    <label for="lastname" class="col-sm-2 control-label">兑换积分：</label>
    <div class="col-sm-10">
      <input type="text" class="form-control" id="PointsFor"  onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'') placeholder="请输入你要兑换的积分值" />
    </div>
  </div>
    <div class="form-group">
     <label for="lastname" class="col-sm-2 control-label">取消兑换：</label>
    <div class="col-sm-10">
    <input type="checkbox" id="toggle-button" name="switch" />
    <label for="toggle-button" class="button-label">
        <span class="circle"></span>
        <span class="text on">ON</span>
        <span class="text off">OFF</span>
    </label>
    </div>
  </div>
</form>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="SureIntegral">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
    </div>
</asp:panel>
<script type="text/javascript">
    $(function () {
        var Points; //现有积分
        var IntegralCeiling; //最大兑换积分值
        var productType; //商品类型
        var productName; //商品名称
        var PointsFor = $("#PointsFor").val(); //兑换积分
        var ProductId; //商品编号
        var SkuId; //商品唯一标识
        var PointsForMoney = 0;

        $.post("/API/ClickIntegralLoad.ashx", { Method: "SelPointsForConten" }, function (data) {
            for (var i = 0; i < data.dt.length; i++) {
                $(".pbox-bottom-left").before(data.dt[i].PointsForConten);
                PointsForMoney = PointsForMoney + parseInt(data.dt[i].IntegralSet); //累加
            }
        }, 'json')

        $("#btnSettlement").click(function () {
            $.post("/API/ClickIntegralLoad.ashx", { Method: "enoughPointFor" }, function (data) {
                if (data == "true") {
                    optioning();
                    location.href = "/Vshop/SubmmitOrder.aspx";
                } else {
                    alert_h('你的积分余额不足！');
                    return false;
                }
            });

        })

        function optioning() {
            $.post("/API/ClickIntegralLoad.ashx", { Method: "DelPointsFor" }, function (data) { //删除积分金额记录
                if (data == "True") {
                } else {
                    alert_h('删除积分金额记录失败！');
                    return false;
                }
            });

            if (PointsForMoney != 0) {
                $.post("/API/ClickIntegralLoad.ashx", { Method: "InsertPointsForMoney", PointsForMoney: PointsForMoney, type: "1" }, function (data) { //添加购物车结算积分金额
                    if (data == "True") {
                    } else {
                        alert_h('添加购物车结算积分金额失败！');
                        return false;
                    }
                });
            }
        }

        $("#toggle-button").click(function () {//取消积分开关点击事件
            if ($("#toggle-button").get(0).checked) {
                $("#PointsFor").val("");
                $("#PointsFor").attr("disabled", true);
            } else {
                $("#PointsFor").attr("disabled", false);
            }
        })


        function IsIntegralToNow(productName, productType, SkuId) {
            $.post("/API/ClickIntegralLoad.ashx", { Method: "GetPointsForByPSU", ProductId: ProductId, SkuId: SkuId }, function (data) {
                var closePointFor;
                if (data.dt.length == 0) {
                    PointsFor = "";
                    closePointFor = "";
                } else {
                    PointsFor = data.dt[0].IntegralSet;
                    closePointFor = data.dt[0].ClosePointsFor;
                }
                if (closePointFor == "") {//选择取消兑换
                    $("#PointsFor").attr("disabled", true);
                    $("#toggle-button").prop("checked", true); ;
                } else {
                    $("#PointsFor").removeAttr("disabled");
                    $("#toggle-button").removeAttr('checked');
                }
                $("#PointsFor").val(PointsFor); //积分兑换赋值
            }, 'json')
            $.ajax({
                url: "/API/ClickIntegralLoad.ashx",
                type: 'post',
                dataType: 'json',
                data: { Method: "ClickIntegralLoad", ProductId: ProductId, SkuId: SkuId },
                success: function (datas) {
                    if (datas.dt.length == 0) {
                        Points = "";
                        IntegralCeiling = "";
                    } else {
                        Points = datas.dt[0].Points;
                        IntegralCeiling = datas.dt[0].IntegralCeiling;
                    }
                    $("#MaxIntegral").val(IntegralCeiling); //最大兑换积分赋值
                    $("#ExistingIntegral").val(Points); //现有积分赋值
                }
            });
        }

        $(".PointsFor").click(function () {//点击使用积分兑换
            var num;
            ProductId = $(this).prev().text(); //商品编号
            productName = $(this).parent().children().eq(1).text(); //商品名称
            productType = $(this).parent().children().eq(2).text(); //商品类型
            SkuId = $(this).next().text(); //商品唯一标识
            $.post("/API/ClickIntegralLoad.ashx", { Method: "SelIntegralToNow", ProductId: ProductId }, function (DataIsSuccess) {
                if (DataIsSuccess == "True") {
                    $("#myModal").modal('show');
                    IsIntegralToNow(productName, productType, SkuId);
                } else {
                    $("#myModal").modal('hide');
                    alert_h("对不起,该商品暂不支持积分兑换！");
                    return false;
                }
            })
        });



        $("#SureIntegral").click(function () {//点击模态框确定
            if ($("#toggle-button").get(0).checked) {
                $.post("/API/ClickIntegralLoad.ashx", { Method: "ClosePointsFor", ProductId: ProductId, SkuId: SkuId }, function (isSuccess) {
                    if (isSuccess == "True") {
                        alert_h("积分兑换成功关闭！");
                        $("#myModal").modal('hide');
                        location.reload();
                    } else if (isSuccess == "False") {
                        alert_h("关闭积分兑换失败！");
                    }
                })
            } else {
                PointsFor = $("#PointsFor").val();
                var litTotal = $("#litTotal").val();

                if (PointsFor == "") {
                    alert_h('兑换积分不能为空！');
                    return false;
                }
                if (PointsFor == 0) {
                    alert_h('兑换积分不能为0！');
                    return false;
                }
                if (PointsFor < 0) {
                    alert_h('兑换积分不能小于0！');
                    return false;
                }
                if (PointsFor > Points) {
                    alert_h('对不起,您的积分余额不足！');
                    return false;
                }
                if (PointsFor > IntegralCeiling) {
                    alert_h('对不起,该商品最多能兑换' + IntegralCeiling + "积分！");
                    return false;
                }
                var content = "<li>(" + productName + " " + productType + "）积分兑换：<span style=color:#ed5565;font-size:18px>-￥" + PointsFor + "</span></li>";
                $.post("/API/ClickIntegralLoad.ashx", { Method: "SaveContent", PointsFor: PointsFor, ProductId: ProductId, content: content, SkuId: SkuId }, function (isSuccess) {
                    if (isSuccess == "True") {
                        $(".pbox-bottom-left").before(content);
                        alert_h("使用积分兑换成功！");
                        $("#myModal").modal('hide');
                        location.reload();
                    } else {
                        alert_h("使用积分兑换失败！");
                    }
                })
            }
        });

        if ($.trim($('#totalPrice').text()) == "￥0.00") {
            $('#cart').addClass('hide');
            $('#empty').removeClass('hide');
        }

        $('div[name="spAdd"]').bind("click", function () {
            var number = $(this).parent().find('[name="buyNum"]');
            number.val(parseInt(number.val()) + 1);
            chageCartProductQuantity(number);
        });
        $('div[name="spSub"]').bind("click", function () {
            var number = $(this).parent().find('[name="buyNum"]');
            var num = parseInt(number.val()) - 1;
            if (num > 0) number.val(parseInt(number.val()) - 1);
            chageCartProductQuantity(number);

        });
        $('[name="buyNum"]').unbind('blur').blur(function () {
            chageCartProductQuantity(this);
        });

        var skuInputs = $('.specification input');
        $.each(skuInputs, function (j, input) {
            var text = '';
            $.each($(input).val().split(';'), function (i, sku) {
                if ($.trim(sku))
                    text += '<span class="property">' + sku.split('：')[1] + '</span>';
            });
            $(input).parent().html(text);

        });

        var list_h = (document.documentElement.clientHeight - 49 - $('.list-empty').height()) * .5 + 'px';
        $('.list-empty').css('margin-top', list_h);
    });


    function chageCartProductQuantity(obj) {
        var type = $(obj).attr("stype");
        if (type == null || type == undefined) {
            type = 0;
        }
        var exchangeId = $(obj).attr("exchangeId");
        if (exchangeId == null || exchangeId == undefined) {
            exchangeId = 0;
        }

        $.ajax({
            url: "/API/VshopProcess.ashx",
            type: 'post', dataType: 'json', timeout: 10000,
            data: { action: "ChageQuantity", skuId: $(obj).attr("skuId"), limitedTimeDiscountId: $(obj).attr("limitedTimeDiscountId"), quantity: parseInt($(obj).val()), type: type, exchangeId: exchangeId },
            success: function (resultData) {
                if (resultData.Status != "OK" && resultData.Status != "0") {
                    alert_h("最多可购买" + resultData.Status + "件");
                    $(obj).val(resultData.Status);
                }
                else {
                    //$('#totalPrice').html('¥' + parseFloat(resultData.TotalPrice).toFixed(2));
                    location.reload();
                }
            }
        });
    }
</script>
<script src="/utility/vshoping.helper.js?2016" type="text/javascript"></script>
<hi:common_footer runat="server" />
